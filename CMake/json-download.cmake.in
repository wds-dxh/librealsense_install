cmake_minimum_required(VERSION 3.6)
project(nlohmann-json-download NONE)

include(ExternalProject)

# Check if the directory already exists before attempting download
if(NOT EXISTS "${CMAKE_BINARY_DIR}/third-party/json")
    ExternalProject_Add(
        nlohmann_json
        PREFIX .

        # We do not use 'GIT_REPOSITORY' as it doesn't support a shallow clone of a specific commit,
        # this make the clone step very long, so we clone by ourselves (See https://gitlab.kitware.com/cmake/cmake/-/issues/17770).
        # Adding detachedHead=false to avoid warnings like: "You are in 'detached HEAD' state..."
        # Only clone if the directory doesn't exist
        DOWNLOAD_COMMAND   git clone -c advice.detachedHead=false --branch v3.11.3 https://github.com/nlohmann/json.git --depth 1 json
        DOWNLOAD_DIR       "${CMAKE_BINARY_DIR}/third-party/"

        # Override default steps with no action, we just want the clone step.
        UPDATE_COMMAND ""
        CONFIGURE_COMMAND ""
        BUILD_COMMAND ""
        INSTALL_COMMAND ""
        )
else()
    # If the directory exists, create a dummy external project to satisfy dependencies
    ExternalProject_Add(
        nlohmann_json
        DOWNLOAD_COMMAND ""
        CONFIGURE_COMMAND ""
        BUILD_COMMAND ""
        INSTALL_COMMAND ""
    )
endif()
    
   
